<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts/PoolMath.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">contracts/</a> PoolMath.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>0/84</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>0/14</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>0/3</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>0/84</span>
      </div>
    </div>
  </div>
  <div class='status-line low'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">//SPDX-License-Identifier: TODO
pragma solidity ^0.8.0;
&nbsp;
import "./Equalize.sol";
import "./Invariant.sol";
&nbsp;
//The code in here is less readable than I'd like because I had to inline a couple of variables to
// avoid solc's "Stack too deep, try removing local variables" error message, because apparently
// solc demands that variables remain accessible on stack, even if
library PoolMath {
&nbsp;
struct Pool {
  uint8 tokenCount;
  Equalized[] balances;
  uint32 ampFactor;
  uint32 totalFee;
  uint32 governanceFee;
  Equalized totalLpSupply;
}
&nbsp;
<span class="fstat-no" title="function not covered" >function addRemove(</span>
  bool isAdd,
  Equalized[] memory amounts,
  Pool memory pool
) internal pure returns (
  Equalized userLpAmount,
  Equalized governanceMintAmount
) { unchecked {
<span class="cstat-no" title="statement not covered" >  uint initialDepth = Invariant.calculateDepth(pool.balances,pool.ampFactor, 0);</span>
<span class="cstat-no" title="statement not covered" >  uint sumPoolBalances = 0;</span>
<span class="cstat-no" title="statement not covered" >  uint sumUpdatedBalances = 0;</span>
<span class="cstat-no" title="statement not covered" >  Equalized[] memory updatedBalances = new Equalized[](pool.balances.length);</span>
<span class="cstat-no" title="statement not covered" >  for (uint i = 0; i &lt; pool.balances.length; ++i) {</span>
<span class="cstat-no" title="statement not covered" >    uint balance = Equalized.unwrap(pool.balances[i]);</span>
<span class="cstat-no" title="statement not covered" >    uint amount = Equalized.unwrap(amounts[i]);</span>
<span class="cstat-no" title="statement not covered" >    uint updatedBalance = isAdd ? balance + amount : balance - amount;</span>
<span class="cstat-no" title="statement not covered" >    updatedBalances[i] = Equalized.wrap(updatedBalance)</span>;
<span class="cstat-no" title="statement not covered" >    sumPoolBalances += balance</span>;
<span class="cstat-no" title="statement not covered" >    sumUpdatedBalances = updatedBalance</span>;
  }
<span class="cstat-no" title="statement not covered" >  uint updatedDepth = Invariant.calculateDepth(</span>
    updatedBalances,
    pool.ampFactor,
    initialDepth * sumUpdatedBalances / sumPoolBalances //initialGuess
  );
&nbsp;
<span class="cstat-no" title="statement not covered" >  if (pool.totalFee != 0) {</span>
<span class="cstat-no" title="statement not covered" >    Equalized[] memory feeAdjustedBalances = new Equalized[](pool.balances.length);</span>
<span class="cstat-no" title="statement not covered" >    for (uint i = 0; i &lt; pool.balances.length; ++i) {</span>
<span class="cstat-no" title="statement not covered" >      uint updatedBalance = Equalized.unwrap(updatedBalances[i]);</span>
<span class="cstat-no" title="statement not covered" >      uint scaledBalance = //rounding?</span>
        Equalized.unwrap(pool.balances[i]) * sumUpdatedBalances / sumPoolBalances;
<span class="cstat-no" title="statement not covered" >      uint taxbase = isAdd</span>
        ? (updatedBalance &gt; scaledBalance ? updatedBalance - scaledBalance : 0)
        : (updatedBalance &lt; scaledBalance ? scaledBalance - updatedBalance : 0);
      //We calculate feeAmount = taxbase * (isAdd ?pool.totalFee : (1/(1-totalFee)-1))
      // but in a way that correctly handles FEE_DECIMALS and is compatible with uint arithmetic.
<span class="cstat-no" title="statement not covered" >      uint feeAmount = isAdd //rounding?</span>
        ? taxbase *pool.totalFee / FEE_DECIMAL_FACTOR
        : taxbase * FEE_DECIMAL_FACTOR / (FEE_DECIMAL_FACTOR - pool.totalFee) - taxbase;
<span class="cstat-no" title="statement not covered" >      require(updatedBalance &gt; feeAmount, "impossible remove")</span>;
<span class="cstat-no" title="statement not covered" >      uint feeAdjustedBalance = updatedBalance - feeAmount;</span>
<span class="cstat-no" title="statement not covered" >      feeAdjustedBalances[i] = Equalized.wrap(feeAdjustedBalance)</span>;
    }
<span class="cstat-no" title="statement not covered" >    uint feeAdjustedDepth =</span>
      Invariant.calculateDepth(feeAdjustedBalances,pool.ampFactor, updatedDepth);
<span class="cstat-no" title="statement not covered" >    userLpAmount = Equalized.wrap( //rounding?</span>
      Equalized.unwrap(pool.totalLpSupply) * (
        isAdd ? feeAdjustedDepth - initialDepth : initialDepth - feeAdjustedDepth //userDepth
      ) / initialDepth
    );
<span class="cstat-no" title="statement not covered" >    uint totalFeeDepth = updatedDepth - feeAdjustedDepth;</span>
<span class="cstat-no" title="statement not covered" >    uint governanceDepth = totalFeeDepth * pool.governanceFee / pool.totalFee;</span> //rounding?
<span class="cstat-no" title="statement not covered" >    uint updatedLpSupply = isAdd</span>
      ? Equalized.unwrap(pool.totalLpSupply) + Equalized.unwrap(userLpAmount)
      : Equalized.unwrap(pool.totalLpSupply) - Equalized.unwrap(userLpAmount);
<span class="cstat-no" title="statement not covered" >    governanceMintAmount = Equalized.wrap( //rounding?</span>
      governanceDepth * updatedLpSupply / (
        (isAdd ? feeAdjustedDepth : updatedDepth) - governanceDepth //totalLpDepth
      )
    );
  }
  else {
<span class="cstat-no" title="statement not covered" >    userLpAmount = Equalized.wrap( //rounding?</span>
      (isAdd ? updatedDepth - initialDepth : initialDepth - updatedDepth)
      * Equalized.unwrap(pool.totalLpSupply) / initialDepth
    );
  }
}}
&nbsp;
<span class="fstat-no" title="function not covered" >function swap(</span>
  bool isInput,
  Equalized[] memory amounts,
  uint8 index,
  Pool memory pool
) internal pure returns (
  Equalized userTokenAmount,
  Equalized governanceMintAmount
) { unchecked {
<span class="cstat-no" title="statement not covered" >  uint initialDepth = Invariant.calculateDepth(pool.balances,pool.ampFactor, 0);</span>
<span class="cstat-no" title="statement not covered" >  Equalized[] memory updatedBalances = new Equalized[](pool.balances.length);</span>
<span class="cstat-no" title="statement not covered" >  for (uint i = 0; i &lt; pool.balances.length; ++i) {</span>
<span class="cstat-no" title="statement not covered" >    uint balance = Equalized.unwrap(pool.balances[i]);</span>
<span class="cstat-no" title="statement not covered" >    uint amount = Equalized.unwrap(amounts[i]);</span>
<span class="cstat-no" title="statement not covered" >    uint updatedBalance = isInput ? balance + amount : balance - amount;</span>
<span class="cstat-no" title="statement not covered" >    updatedBalances[i] = Equalized.wrap(updatedBalance)</span>;
  }
<span class="cstat-no" title="statement not covered" >  Equalized[] memory knownBalances = new Equalized[](pool.balances.length-1);</span>
<span class="cstat-no" title="statement not covered" >  if (isInput &amp;&amp;pool.totalFee != 0) {</span>
<span class="cstat-no" title="statement not covered" >    for (uint i = 0; i &lt; knownBalances.length; ++i) {</span>
<span class="cstat-no" title="statement not covered" >      uint j = i &lt; index ? i : i+1;</span>
<span class="cstat-no" title="statement not covered" >      uint amount = Equalized.unwrap(amounts[j]);</span>
<span class="cstat-no" title="statement not covered" >      uint updatedBalance = Equalized.unwrap(updatedBalances[j]);</span>
<span class="cstat-no" title="statement not covered" >      uint inputFeeAmount = amount *pool.totalFee / FEE_DECIMAL_FACTOR;</span> //rounding?
<span class="cstat-no" title="statement not covered" >      uint knownBalance = updatedBalance - inputFeeAmount;</span>
<span class="cstat-no" title="statement not covered" >      knownBalances[i] = Equalized.wrap(knownBalance)</span>;
    }
  }
  else {
<span class="cstat-no" title="statement not covered" >    for (uint i = 0; i &lt; knownBalances.length; ++i) {</span>
<span class="cstat-no" title="statement not covered" >      uint j = i &lt; index ? i : i+1;</span>
<span class="cstat-no" title="statement not covered" >      knownBalances[i] = updatedBalances[j]</span>;
    }
  }
<span class="cstat-no" title="statement not covered" >  uint initialGuess = isInput ? Equalized.unwrap(pool.balances[index]) : 0;</span>
<span class="cstat-no" title="statement not covered" >  uint unknownBalance = Equalized.unwrap(</span>
    Invariant.calculateUnknownBalance(knownBalances, initialDepth,pool.ampFactor, initialGuess)
  );
&nbsp;
<span class="cstat-no" title="statement not covered" >  uint _userTokenAmount;</span>
<span class="cstat-no" title="statement not covered" >  if (isInput) {</span>
<span class="cstat-no" title="statement not covered" >    _userTokenAmount = Equalized.unwrap(pool.balances[index]) - unknownBalance</span>;
<span class="cstat-no" title="statement not covered" >    updatedBalances[index] =</span>
      Equalized.wrap(Equalized.unwrap(updatedBalances[index]) - _userTokenAmount);
  }
  else {
<span class="cstat-no" title="statement not covered" >    _userTokenAmount = unknownBalance - Equalized.unwrap(pool.balances[index])</span>;
<span class="cstat-no" title="statement not covered" >    if (pool.totalFee != 0) {</span>
<span class="cstat-no" title="statement not covered" >      _userTokenAmount = //rounding?</span>
        _userTokenAmount * FEE_DECIMAL_FACTOR / (FEE_DECIMAL_FACTOR - pool.totalFee)
        - _userTokenAmount;
    }
<span class="cstat-no" title="statement not covered" >    updatedBalances[index] =</span>
      Equalized.wrap(Equalized.unwrap(updatedBalances[index]) + _userTokenAmount);
  }
<span class="cstat-no" title="statement not covered" >  userTokenAmount = Equalized.wrap(_userTokenAmount)</span>;
&nbsp;
<span class="cstat-no" title="statement not covered" >  if (pool.totalFee != 0) {</span>
<span class="cstat-no" title="statement not covered" >    uint finalDepth = Invariant.calculateDepth(pool.balances,pool.ampFactor, initialDepth);</span>
<span class="cstat-no" title="statement not covered" >    uint totalFeeDepth = finalDepth - initialDepth;</span>
<span class="cstat-no" title="statement not covered" >    uint governanceDepth = totalFeeDepth *pool.governanceFee /pool.totalFee;</span> //rounding?
<span class="cstat-no" title="statement not covered" >    uint totalLpDepth = finalDepth - governanceDepth;</span>
<span class="cstat-no" title="statement not covered" >    uint _totalLpSupply = Equalized.unwrap(pool.totalLpSupply);</span>
<span class="cstat-no" title="statement not covered" >    uint _governanceMintAmount = governanceDepth * _totalLpSupply / totalLpDepth;</span>
<span class="cstat-no" title="statement not covered" >    governanceMintAmount = Equalized.wrap(_governanceMintAmount)</span>;
  }
}}
&nbsp;
<span class="fstat-no" title="function not covered" >function removeExactBurn(</span>
  Equalized burnAmount,
  uint8 outputIndex,
  Pool memory pool
) internal pure returns (
  Equalized outputAmount,
  Equalized governanceMintAmount
) { unchecked {
  //RemoveExactBurnCache memory cache = RemoveExactBurnCache(0, 0, 0);
<span class="cstat-no" title="statement not covered" >  uint updatedLpSupply = Equalized.unwrap(pool.totalLpSupply) - Equalized.unwrap(burnAmount);</span>
<span class="cstat-no" title="statement not covered" >  uint updatedDepth = //rounding?</span>
    Invariant.calculateDepth(pool.balances, pool.ampFactor, 0) //initialDepth
    * updatedLpSupply / Equalized.unwrap(pool.totalLpSupply);
<span class="cstat-no" title="statement not covered" >  Equalized[] memory knownBalances = new Equalized[](pool.balances.length-1);</span>
<span class="cstat-no" title="statement not covered" >  for (uint i = 0; i &lt; knownBalances.length; ++i) {</span>
<span class="cstat-no" title="statement not covered" >    uint j = i &lt; outputIndex ? i : i+1;</span>
<span class="cstat-no" title="statement not covered" >    knownBalances[i] = pool.balances[j]</span>;
  }
<span class="cstat-no" title="statement not covered" >  uint baseAmount = Equalized.unwrap(pool.balances[outputIndex]) - Equalized.unwrap(</span>
    Invariant.calculateUnknownBalance(
      knownBalances,
      updatedDepth,
      pool.ampFactor,
      Equalized.unwrap(pool.balances[outputIndex])
    ));
<span class="cstat-no" title="statement not covered" >  if (pool.totalFee != 0) {</span>
<span class="cstat-no" title="statement not covered" >    uint sumPoolBalances = Invariant.sum(pool.balances);</span>
    //64 bits or less:
<span class="cstat-no" title="statement not covered" >    uint taxableFraction = ( //rounding?</span>
      (sumPoolBalances - Equalized.unwrap(pool.balances[outputIndex]))&lt;&lt;64
    ) / sumPoolBalances;
    //totalFee is less than FEE_DECIMAL_FACTOR/2, hence 2&lt;&lt;64 is an upper bound for the quotient,
    // and therefore overall fee is &lt; 1&lt;&lt;64, i.e. fits in 64 bits or less:
<span class="cstat-no" title="statement not covered" >    uint fee = (FEE_DECIMAL_FACTOR&lt;&lt;64) / (FEE_DECIMAL_FACTOR - pool.totalFee) - (1&lt;&lt;64);</span> //rounding?
<span class="cstat-no" title="statement not covered" >    outputAmount = Equalized.wrap(</span>
      baseAmount - fee * (
        //(64 bits * 64 bits) / (64 bits + (64 bits * 64 bits)&gt;&gt;64) = 128 / 64 = 64 bits or less:
        (baseAmount * taxableFraction) / ((1&lt;&lt;64) + ((taxableFraction * fee)&gt;&gt;64))
      )
    );
    //In the next line we're assigning to a function parameter (bad) that's a reference too
    // (way worse still). Otoh, we're not using pool.balances for anything else, neither inside
    // this function, nor within the larger context of the entire contract invocation. Hence,
    // copying the entire array and wasting a bunch of gas in the process, just to neurotically
    //and autistically avoid a code smell is even less palatable. So here goes...
<span class="cstat-no" title="statement not covered" >    pool.balances[outputIndex] = Equalized.wrap(</span>
      Equalized.unwrap(pool.balances[outputIndex]) - Equalized.unwrap(outputAmount)
    );
<span class="cstat-no" title="statement not covered" >    uint totalFeeDepth =</span>
      Invariant.calculateDepth(pool.balances, pool.ampFactor, updatedDepth) //finalDepth
      - updatedDepth;
<span class="cstat-no" title="statement not covered" >    uint governanceDepth = totalFeeDepth * pool.governanceFee / pool.totalFee;</span>
<span class="cstat-no" title="statement not covered" >    governanceMintAmount = Equalized.wrap(</span>
      governanceDepth * updatedLpSupply / (
        updatedDepth + totalFeeDepth - governanceDepth //lpDepth
      )
    );
  }
  else {
<span class="cstat-no" title="statement not covered" >    outputAmount = Equalized.wrap(baseAmount)</span>;
  }
}}
&nbsp;
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Tue Jul 12 2022 12:54:42 GMT+0200 (Central European Summer Time)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
